/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var E=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var L=(g,d)=>{for(var e in d)E(g,e,{get:d[e],enumerable:!0})},D=(g,d,e,t)=>{if(d&&typeof d=="object"||typeof d=="function")for(let s of S(d))!M.call(g,s)&&s!==e&&E(g,s,{get:()=>d[s],enumerable:!(t=x(d,s))||t.enumerable});return g};var N=g=>D(E({},"__esModule",{value:!0}),g);var H={};L(H,{default:()=>C});module.exports=N(H);var w=require("obsidian");var b=require("obsidian"),y=class extends b.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new b.Setting(e).setName("\u62D6\u5C3E\u5F00\u5173 Trail enable").setDesc("\u662F\u5426\u542F\u7528\u62D6\u5C3E").addToggle(t=>t.setValue(this.plugin.setting.enableTrail).onChange(async s=>{this.plugin.setting.enableTrail=s,await this.plugin.saveSettings()})),new b.Setting(e).setName("\u62D6\u5C3E\u989C\u8272 Trail color").setDesc("\u8BBE\u7F6E\u62D6\u5C3E\u989C\u8272").addColorPicker(t=>{t.setValue(this.plugin.setting.trailColor).onChange(async s=>{this.plugin.setting.trailColor=s,await this.plugin.saveSettings()})}),new b.Setting(e).setName("\u62D6\u5C3E\u901F\u5EA6 Trail speed").setDesc("\u8BBE\u7F6E\u62D6\u5C3E\u66F4\u65B0\u6B21\u6570\uFF0C\u8D8A\u5927\u8D8A\u6162 More bigger,more slower").addText(t=>{t.inputEl.type="number",t.setPlaceholder("\u989C\u8272\u5B57\u7B26\u4E32\u6216\u989C\u8272\u4EE3\u7801").setValue(this.plugin.setting.trailStep.toString()).onChange(async s=>{this.plugin.setting.trailStep=parseInt(s),await this.plugin.saveSettings()})})}};var F={trailStep:30,enableTrail:!0,trailColor:"#78dce8",trailColorDark:"#78dce8"},C=class extends w.Plugin{constructor(){super(...arguments);this.observer=null;this.settingObserver=null;this.isMouseDown=!1;this.mouseForX={down:0,move:0};this.mouseForY={down:0,move:0};this.isScroll=!1;this.focus=!0;this.closeSettings=!1;this.events={};this.lastPos={x:0,y:0,height:0};this.lastPosForChangeFile={x:0,y:0,height:0};this.rectangle={x:0,y:0,dirX:0,dirY:0,extTarget:0,extOrigin:0};this.isFirstTrail=!0}async onload(){console.log("Smooth Cursor loaded"),await this.loadSettings(),this.addSettingTab(new y(this.app,this)),this.app.workspace.onLayoutReady(()=>{this.registerEvent(this.app.workspace.on("file-open",e=>{this.uninit(),e!==null?(this.isFirstTrail=!1,this.delayedFrames(this.init,10)):(this.lastPosForChangeFile={x:0,y:0,height:0},this.events={})})),this.init()})}onunload(){var e,t;(e=this.cursor)==null||e.remove(),(t=this.canvas)==null||t.remove(),this.stopObserving(),console.log("Smooth Cursor unloaded")}isVimMode(){return document.querySelector(".cm-vimCursorLayer")!==null}isVisible(e){return!!e.offsetParent}eventRegister(e,t,s){let o=this.events[t];o||(o=s,this.events[t]=o),this.registerDomEvent(e,t,o)}uninit(){var e,t;(e=this.cursor)==null||e.remove(),(t=this.canvas)==null||t.remove(),this.isFirstTrail=!0,this.cursor=null,this.canvas=null,this.trailCount=0,this.stopObserving()}init(){let e=document.querySelectorAll(".cm-editor");for(let t=0;t<e.length;t++){let s=e[t];if(this.isVisible(s)){this.editorDom=s,this.test=s.getBoundingClientRect();break}}if(!this.editorDom){console.error("\u672A\u6253\u5F00\u6587\u6863");return}this.cursor=this.app.workspace.containerEl.createDiv({cls:"smooth-cursor-busyo"}),this.cursor.id="smooth-cursor-busyo",this.editorDom.appendChild(this.cursor),this.vimText=this.app.workspace.containerEl.createDiv(),this.cursor.appendChild(this.vimText),this.vimText.classList.add("vim-text"),this.delayedFrames(()=>{let t=document.querySelectorAll("style"),s="smooth-cursor-busyo",o="vim-text";for(let n=0;n<t.length;n++){let r=t[n],i=r.textContent;i.includes(s)&&(this.customStyle=r),i.includes(o)&&(this.vimStyle=r)}},10),this.createTrail(),this.setting.enableTrail||this.cursor.addClass("show"),this.eventRegister(this.editorDom,"mousedown",t=>{var s;this.isMouseDown=!0,this.mouseForX.down=t.clientX,this.mouseMoveTaget={down:t.target,move:t.target},this.mouseForY.down=((s=this.updateCursor())==null?void 0:s.y)||0}),this.eventRegister(this.editorDom,"mousemove",t=>{var s;this.isMouseDown&&(this.mouseMoveTaget.move=t.target,this.mouseForX.move=t.clientX,this.mouseForY.move=((s=this.updateCursor())==null?void 0:s.y)||0)}),this.eventRegister(this.editorDom,"mouseup",()=>{this.isMouseDown=!1,this.updateCursor()}),this.eventRegister(this.editorDom,"keydown",t=>{let s=this.updateCursor()}),this.eventRegister(this.editorDom,"keyup",()=>{this.updateCursor()}),this.registerEvent(this.app.workspace.on("resize",()=>{this.canvas&&(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight),this.isScroll=!0,this.updateCursor()})),this.eventRegister(this.editorDom.querySelector(".cm-scroller"),"scroll",()=>{this.isScroll=!0,this.updateCursor()}),this.lastPos=this.lastPosForChangeFile,this.startObserving(),this.registerEvent(this.app.workspace.on("active-leaf-change",t=>{var s,o;t&&t.view.containerEl.contains(this.editorDom)?(this.focus=!0,document.body.addClass("caret-hide"),(s=this.cursor)==null||s.addClass("show")):(this.focus=!1,document.body.removeClass("caret-hide"),(o=this.cursor)==null||o.removeClass("show"))})),document.body.addClass("caret-hide"),this.updateCursor()}updateCursor(){var l,a;if(!this.cursor||!this.customStyle)return;let t=window.getSelection().getRangeAt(0).commonAncestorContainer,s=!1;t.nodeType===Node.ELEMENT_NODE?s=t.classList.contains("inline-title"):t.nodeType===Node.TEXT_NODE&&(s=t.parentElement.classList.contains("inline-title")),this.closeSettings=!1;let o=this.getCursorPosition(s);if(o.x==-1&&o.y==-1){this.focus=!1,(l=this.cursor)==null||l.removeClass("show");return}else this.focus=!0,(a=this.cursor)==null||a.addClass("show");let n=window.scrollX||document.documentElement.scrollLeft,r=window.scrollY||document.documentElement.scrollTop;if(this.isScroll?this.cursor.addClass("noTrans"):this.cursor.removeClass("noTrans"),this.isVimMode()){let h=this.getNextCharAfterCursor(s);h?(this.vimText&&(this.vimText.textContent=h.text),this.vimStyle.textContent=this.vimStyle.textContent.replace(/(--vim-font-size:\s*[^;]+;)/,`--vim-font-size: ${h.size};`)):this.vimText&&(this.vimText.textContent="")}else this.vimText&&(this.vimText.textContent="");let i=this.customStyle.textContent.replace(/(--cursor-x:\s*[^;]+;)/,`--cursor-x: ${o.x+n};`);return i=i.replace(/(--cursor-y:\s*[^;]+;)/,`--cursor-y: ${o.y+r};`),i=i.replace(/(--cursor-height:\s*[^;]+;)/,`--cursor-height: ${o.height};`),this.customStyle.textContent=i,this.setting.enableTrail&&!this.isScroll&&(this.lastPos.x!=o.x||this.lastPos.y!=o.y)&&this.updateTrail(this.lastPos.x,this.lastPos.y,o.x,o.y,o.height,this.lastPos.height),this.setting.enableTrail&&this.cursor.hasClass("noAni")?this.cursor.removeClass("noAni"):this.setting.enableTrail||(this.cursor.addClass("noAni"),setTimeout(()=>{var h;(h=this.cursor)==null||h.removeClass("noAni")},80)),this.lastPos=o,this.editorDom.getBoundingClientRect().width!==0&&(this.lastPosForChangeFile=o),this.isScroll=!1,o}getNextCharAfterCursor(e){var t;if(e)return null;{let s=(t=this.app.workspace.activeEditor)==null?void 0:t.editor,o=s==null?void 0:s.cm;if(o&&s){let n=s.getCursor(),r=o.state.doc,i=r.lines;if(!(n.line+1>=i)){let l=r.line(n.line+1),a=Math.min(n.ch,l.length),h=l.from+a;if(h<l.to){let p=r.sliceString(h,h+1),c=o.coordsAtPos(h);if(c){let T=document.elementFromPoint(c.left,c.top);if(T){let f=window.getComputedStyle(T).fontSize;return{text:p,size:f}}}}else return null}}}}getCursorPosition(e){var s,o;let t=this.editorDom.getBoundingClientRect();if(e){let i=window.getSelection().getRangeAt(0).getClientRects()[0],l=this.mouseForX.move<=this.mouseForX.down;return{x:i.x+(l?0:i.width)+window.scrollX-t.x,y:i.y+window.scrollY-t.y,height:i.height}}else{let n=(s=this.app.workspace.activeEditor)==null?void 0:s.editor,r=n==null?void 0:n.cm;if(r&&n){let i=n.getCursor(),l=r.state.doc.line(i.line+1).from+i.ch,a=r.coordsForChar(l);if(!a){let p=window.getSelection().getRangeAt(0),c=p.commonAncestorContainer,T=!1,f=c;for(;f&&(f.nodeType===Node.ELEMENT_NODE?T=Array.from(f.classList).some(u=>u.includes("table")):f.nodeType===Node.TEXT_NODE&&(T=Array.from(f.parentElement.classList).some(u=>u.includes("table"))),!T);)f=f.parentNode;if(T){if((!this.mouseMoveTaget||this.mouseMoveTaget.down.textContent===this.mouseMoveTaget.move.textContent)&&c.nodeType===Node.TEXT_NODE){let u=this.mouseForX.move<=this.mouseForX.down,m=document.createRange();m.setStart(c,u?p.startOffset:p.endOffset),m.setEnd(c,u?p.startOffset:p.endOffset);let v=m.getBoundingClientRect();return{x:v.x+(u?0:v.width)+window.scrollX-t.x,y:v.y+window.scrollY-t.y,height:v.height}}}else{let u=r.domAtPos(l);if(c=u.node,!((o=c.parentElement)!=null&&o.classList.contains("cm-contentContainer"))){if(c.nodeType===Node.ELEMENT_NODE){let m=c.getClientRects();m.length>0&&(a=m[m.length-1])}else if(c.nodeType===Node.TEXT_NODE){let m=document.createRange();m.setStart(c,u.offset),m.setEnd(c,u.offset);let v=m.getBoundingClientRect();(v.width||v.height)&&(a=v)}}}}if(a)return{x:a.left+window.scrollX-t.x,y:a.top+window.scrollY-t.y,height:a.bottom-a.top}}}return{x:-1,y:-1,height:0}}startObserving(){let e=document.querySelector(".cm-contentContainer");for(;!e;)e=document.querySelector(".cm-contentContainer");this.observer=new MutationObserver(t=>{var o,n;let s=!1;for(let r of t)if(r.type==="childList"){for(let i=0;i<r.addedNodes.length;i++)if(r.addedNodes[i].nodeName!="BR"&&!((o=r.addedNodes[i].classList)!=null&&o.contains("table-cell-wrapper"))){s=!0;break}for(let i=0;i<r.removedNodes.length;i++)if(r.removedNodes[i].nodeName!="BR"&&!((n=r.removedNodes[i].classList)!=null&&n.contains("table-cell-wrapper"))){s=!0;break}}s&&this.delayedFrames(()=>{this.updateCursor()})}),this.settingObserver=new MutationObserver(t=>{var s,o,n;for(let r of t)if(r.type==="childList"){for(let i=0;i<r.addedNodes.length;i++)if(r.addedNodes[i].nodeName=="DIV"&&((s=r.addedNodes[i].classList)!=null&&s.contains("modal-container"))){this.focus=!1,document.body.removeClass("caret-hide"),(o=this.cursor)==null||o.removeClass("show");break}for(let i=0;i<r.removedNodes.length;i++)if(r.removedNodes[i].nodeName=="DIV"&&((n=r.removedNodes[i].classList)!=null&&n.contains("modal-container"))){this.focus=!0,document.body.addClass("caret-hide"),this.closeSettings=!0;break}}}),this.observer.observe(e,{childList:!0,subtree:!0}),this.settingObserver.observe(document.body,{childList:!0,subtree:!0})}stopObserving(){var e,t;(e=this.observer)==null||e.disconnect(),this.observer=null,(t=this.settingObserver)==null||t.disconnect(),this.settingObserver=null}delayedFrames(e,t=2){let s=0,o=this,n=()=>{s++,s===t?e.call(o):requestAnimationFrame(n)};requestAnimationFrame(n)}createTrail(){let e=this;this.canvas=this.editorDom.createEl("canvas",{cls:"smooth-cursor-busyo-canvas"}),this.canvas.id="trail-canvas";let t=this.canvas.getContext("2d");this.canvas.width=this.editorDom.innerWidth,this.canvas.height=this.editorDom.innerHeight;function s(){if(e.canvas===null||t===null)return;if(e.cursor&&e.trailCount<=0){t.clearRect(0,0,e.canvas.width,e.canvas.height),e.focus&&!e.closeSettings&&e.cursor.addClass("show");return}e.trailCount--;let n=e.trailCount/e.setting.trailStep,r=e.rectangle.x-e.rectangle.dirX*.15*Math.max(0,-.3+n),i=r,l=e.rectangle.x-e.rectangle.dirX*n,a=l;e.rectangle.dirX===3?(r=e.rectangle.x,i=r,l=e.rectangle.x-e.rectangle.dirX,a=l):e.rectangle.dirY<0?(i=e.rectangle.x-e.rectangle.dirX*.05*Math.max(0,-.3+n),l=e.rectangle.x-e.rectangle.dirX*Math.max(0,n-.02)):e.rectangle.dirY>0&&(r=e.rectangle.x-e.rectangle.dirX*.05*Math.max(0,-.3+n),a=e.rectangle.x-e.rectangle.dirX*Math.max(0,n-.02));let h=e.rectangle.extTarget-e.rectangle.extOrigin;t.clearRect(0,0,e.canvas.width,e.canvas.height),t.beginPath(),t.moveTo(r,e.rectangle.y+e.rectangle.extTarget),t.lineTo(i,e.rectangle.y),t.lineTo(l,e.rectangle.y-e.rectangle.dirY*n),t.lineTo(a,e.rectangle.y-e.rectangle.dirY*n+e.rectangle.extTarget-h*n),t.closePath(),t.fillStyle=e.setting.trailColor,t.fill()}function o(){e.canvas!==null&&(s(),requestAnimationFrame(o))}o()}updateTrail(e,t,s,o,n,r){if(this.cursor===null)return;if(this.isFirstTrail){this.isFirstTrail=!1,this.cursor.addClass("show");return}let i=s-e,l=o-t;this.rectangle.x=s,this.rectangle.y=o,this.rectangle.dirX=i==0?3:i,this.rectangle.dirY=l,this.rectangle.extTarget=n,this.rectangle.extOrigin=r,this.trailCount=this.setting.trailStep,this.cursor.removeClass("show")}async loadSettings(){this.setting=Object.assign({},F,await this.loadData())}async saveSettings(){await this.saveData(this.setting)}updateSetting(){this.cursor}};

/* nosourcemap */